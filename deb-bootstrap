#!/bin/bash

set -e -x

cd $(dirname $0)

SLACK_DEB='https://downloads.slack-edge.com/linux_releases/slack-desktop-2.1.0-amd64.deb'
NEOVIM_CONFIG='https://github.com/vito/dot-nvim.git'

function gimme() {
  sudo apt-get -y install "$@"
}

# ntp setup (be sure to configure the timezone yourself)
gimme ntp

# tooling for managing apt repositories
gimme software-properties-common

# provides virtualbox
sudo apt-add-repository -y contrib

# provides neovim (conditional; adding ppas repeatedly adds duplicate lines)
if ! [ -e /etc/apt/sources.list.d/neovim-ppa-ubuntu-unstable-xenial.list ]; then
  sudo add-apt-repository -y ppa:neovim-ppa/unstable
fi

# sync up everything
sudo apt-get update

# install neovim, + python for plugins, + xsel for copy/paste
gimme \
  neovim \
  python-dev python-pip python3-dev python3-pip \
  xsel

# support for python3 plugins
sudo pip3 install neovim

# set up neovim as vi/vim/editor
sudo update-alternatives --install /usr/bin/vi vi /usr/bin/nvim 60
sudo update-alternatives --set vi /usr/bin/nvim
sudo update-alternatives --install /usr/bin/vim vim /usr/bin/nvim 60
sudo update-alternatives --set vim /usr/bin/nvim
sudo update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 60
sudo update-alternatives --set editor /usr/bin/nvim

# bootstrap neovim config (`git pull` on your own)
if ! [ -e ~/.config/nvim ]; then
  git clone "$NEOVIM_CONFIG" ~/.config/nvim --recursive
fi

# config orchestration
gimme stow

# tiling window manager
gimme compton i3 conky
stow i3

# shell
gimme fish
stow fish
sudo chsh -s /usr/bin/fish $(whoami)

# ms fonts, Iosevka for monospace, font hinting config/etc.
gimme ttf-mscorefonts-installer
stow fonts
gsettings set org.gnome.desktop.interface monospace-font-name 'Iosevka 12'

# ruby + gem config
gimme ruby
stow gem

# git
gimme git
stow git
GEM_HOME=$HOME/.gems gem install git-duet

# golang
gimme golang
GOPATH=$HOME/go vim --headless +GoInstallBinaries +qa

# node, npm, elm
# nodejs-legacy to provide 'node' binary which many packages assume
gimme nodejs nodejs-legacy npm
sudo npm install -g uglify-js less less-plugin-clean-css elm elm-oracle elm-test

# postgresql
gimme postgresql
sudo usermod -aG postgres $(whoami)

# create superuser role for current user with empty password
yes "" | sudo su postgres -c "createuser -s -P $(whoami)" || true

# NB: virtualbox shells out to `ifconfig` and `route` and silently fails if
# they're not available. do we need to install it?
gimme virtualbox vagrant
sudo usermod -aG vboxusers $(whoami)

# misc tooling
gimme htop silversearcher-ag direnv lastpass-cli pavucontrol curl jq

# install slack client
if ! which slack 2>&1 >/dev/null; then
  curl "$SLACK_DEB" > /tmp/slack.deb
  sudo gdebi -n /tmp/slack.deb
fi

# gnome-terminal palette
profiles=/org/gnome/terminal/legacy/profiles:/
profile_name="$(dconf list ${profiles} | grep : | head -n1)"
if [ -n "$profile_name" ]; then
  profile="${profiles}${profile_name}"

  dconf write ${profile}palette "['rgb(48,48,48)', 'rgb(211,112,163)', 'rgb(109,158,63)', 'rgb(181,136,88)', 'rgb(96,149,197)', 'rgb(172,123,222)', 'rgb(59,162,117)', 'rgb(207,207,207)', 'rgb(104,104,104)', 'rgb(255,167,218)', 'rgb(163,213,114)', 'rgb(239,189,139)', 'rgb(152,203,254)', 'rgb(229,176,255)', 'rgb(117,218,169)', 'rgb(255,255,255)']"
  dconf write ${profile}use-theme-colors 'false'
  dconf write ${profile}foreground-color "'rgb(207,207,207)'"
  dconf write ${profile}background-color "'rgb(35,35,35)'"
fi
